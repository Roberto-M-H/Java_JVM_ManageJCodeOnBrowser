<!doctype html>
<html lang='en'>
<head>
	<meta charset='utf-8'><meta http-equiv='x-ua-compatible' content='ie=edge'>
	<link rel='shortcut icon' href='https://lorenzoongithub.github.io/nudge4j/favicon.ico' />
	<style>
		a               {color:#428bca;text-decoration:none}
		a:hover,a:focus {color:#2a6496;text-decoration:underline} 
	</style>
	<title>n4j - console</title>
</head>
<body style='font-family:monospace'>
<pre id='editor' style='position:absolute;top:2%;left:1%;right:1%;bottom:50%;border:1px solid #888;'>//
// Write your code here.
//
//
java.lang.Thread.activeCount();</pre>
<input id='btnEval' type='button' value='Execute on JVM' style='position:absolute;font-family:monospace;left:1%; top:50%;margin-top:5px;height:26px;cursor:pointer;' />
<pre id='divResponse' style='position:absolute;top:50%;left:1%;right:1%;margin-top:40px;'>
<i style='opacity:0.5'>JVM output will be printed here</i>
</pre>
<a href='https://lorenzoongithub.github.io/nudge4j/' 
   style='position:absolute;right:3%;top:2%;border:1px solid #888;border-radius:8px;padding:2px 4px;background-color:#f8f8f8;font-size:11px;z-index:999'>nudge4j</a>

<script id='$0x'>
!function(){ // IIFE begins

//
// xhrSendSnippet: ajax function to post code for the JVM to execute. 
//
var xhrSendSnippet = (function() {
	var xhrPost = function(url, postData, callback) {
		var x = window.XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject('Microsoft.XMLHTTP');
		x.onreadystatechange = function() {
			if (x.readyState != 4) {
				return;
			}
			if (x.status == 200) {
				callback(null, x.responseText);
				return;
			}
			callback('Failure on HTTP Post',null);
		};
		try {
			x.open('POST', url, true);
			x.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
			x.send(postData);
		} catch (e) {
			callback('Failure on HTTP Post - '+e,null)
		}
	};
	
	return function(snippet, callback) {	
		xhrPost('/runJS', snippet, function(err, content) {
			if (err != null) {
				callback(err, null);
				return;
			} 
			if (content.substring(0,7) == '$error:') {
				callback(content.substring(7),null); 
			} else {
				callback(null, content);	
			}
		});
	}
})();

if (location.search.substring(0,6) == '?code=') {
	document.getElementById('editor').innerHTML = decodeURIComponent(location.search.substring(6));    
}

function loadAceEditorAndThen(callback) {
    var script = document.createElement('script'); 
    script.type  = 'text/javascript';
    script.async = true;
    script.src   = 'https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.3/ace.js';
    var entry = document.getElementById('$0x');
    entry.parentNode.insertBefore(script, entry);
    if (script.addEventListener) {
        script.addEventListener('load', callback, false);
    } else {
        script.attachEvent('onreadystatechange', function() {
            if (/complete|loaded/.test(script.readyState))
                callback();
        });
    }
}

loadAceEditorAndThen(function() {
	var editor = ace.edit('editor');
	editor.setTheme('ace/theme/eclipse');
	editor.getSession().setMode('ace/mode/javascript');
	
	var btnEval = document.getElementById('btnEval');
	var divResponse = document.getElementById('divResponse'); 
	
	btnEval.onclick= function() {
		btnEval.disabled = true; 
		divResponse.innerHTML = '<img src="http://i.imgur.com/C6y2Fmf.gif"/>';
		xhrSendSnippet(editor.getValue(), function(err,response) {
			btnEval.disabled = false;
			if (err) {
				divResponse.innerHTML = '<pre style="color:#A44">'+err+'</pre>';
				return;
			}	
			if (response.substr(0,6)=='$html:') {
				divResponse.innerHTML = response.substr(6);
			} else {
				// see:http://stackoverflow.com/questions/6234773/can-i-escape-html-special-chars-in-javascript
				divResponse.innerHTML = response.replace(/&/g, '&amp;')
										        .replace(/</g, '&lt;')
										        .replace(/>/g, '&gt;')
										        .replace(/"/g, '&quot;')
										        .replace(/'/g, '&#039;');
			} 
		});
	}
	
	if (location.href == 'https://lorenzoongithub.github.io/nudge4j/iframe.html') {
		btnEval.disabled = true; 
	}
});
}(); // IIFE ends 
</script>
</body>
</html>