<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<link rel='shortcut icon' href='https://lorenzoongithub.github.io/nudge4j/favicon.ico' /><title>nudge4j</title>
<style>
body{font-family:sans-serif;font-size:18px;line-height:1.5;overflow-y:scroll;margin:0;padding:0;border:0}
h2 { font-weight:normal; }
a {color:#428bca;text-decoration:none;cursor:pointer}
a:hover,
a:focus{color:#2a6496;text-decoration:underline}
h2 {margin:60px 0 10px 0; font-weight:normal}
sup {font-size:75%}
pre {margin:0 0 32px 0;padding:4px;overflow:hidden;font-size:13px;border:1px solid #aaa; }
input[type=button] {cursor:pointer;}
b { font-size:120%; color:purple; margin:3px 0; display:inline-block;}
textarea { white-space:pre;width:100%;overflow:hidden;resize:none;background-color:#000;color:white;font-size:10px;}
</style>
</head>
<body>

<div style='padding:12%;background-color:#000;color:white;'>
<div style='font-size:200%;font-weight:bold;color:purple'>nudge4j: GET INSIDE YOUR JVM</div>
<div>
nudge4j is a tiny piece of java code to make your java application accessible to the browser.
It's meant for use during development to provide an environment for experimenting with code against a running application.
</div>
</div>

<div style='margin:-50px auto 0;width:688px;height:326px;overflow:hidden;border-radius:6px'>
    <img src="n4j.in.action.gif"  style='width:692px;height:490px;margin:-24px 0 0 -2px'/>
</div>

<div style='padding:2%;'>

<h2>Requirements</h2>
<ul>
<li>java 8</li>
<li>internet access</li>
<li>a modern browser (Chrome, Firefox, IE12)</li>
</ul>


 
<h2>Integration</h2>
<div>
copy/paste this code anywhere where it is going to be executed and restart your JVM <a href='https://lorenzoongithub.github.io/nudge4j/dist/demo/nudge4j/DemoN4J.java'>(complete example)</a>
</div>


<div>
<button style='font-size:9px; font-weight:bold; cursor:pointer;' class="xbtn" data-clipboard-action="copy" data-clipboard-target="#taCode">BUTTON: COPY TO CLIPBOARD</button>
<textarea id='taCode' readonly cols='100' rows='93' >{{{ 
(new java.util.function.Consumer&lt;Object[]&gt;() { public void accept(Object args[]) {
    try {
        javax.script.ScriptEngine engine = new javax.script.ScriptEngineManager().getEngineByName("JavaScript");
        engine.put("args", args);
        Class&lt;?&gt; HttpHandler= Class.forName("com.sun.net.httpserver.HttpHandler");
        java.lang.reflect.Method 
        getRequestURI =       Class.forName("com.sun.net.httpserver.HttpExchange").getMethod("getRequestURI"),
        getResponseHeaders =  Class.forName("com.sun.net.httpserver.HttpExchange").getMethod("getResponseHeaders"),
        set =                 Class.forName("com.sun.net.httpserver.Headers").     getMethod("set", String.class,String.class),
        sendResponseHeaders = Class.forName("com.sun.net.httpserver.HttpExchange").getMethod("sendResponseHeaders",int.class,long.class),
        getResponseBody =     Class.forName("com.sun.net.httpserver.HttpExchange").getMethod("getResponseBody"),
        getQuery =            Class.forName("java.net.URI").                       getMethod("getQuery"),
        create =              Class.forName("com.sun.net.httpserver.HttpServer").  getMethod("create", java.net.InetSocketAddress.class, int.class),
        createContext =       Class.forName("com.sun.net.httpserver.HttpServer").  getMethod("createContext", String.class, HttpHandler),
        setExecutor =         Class.forName("com.sun.net.httpserver.HttpServer").  getMethod("setExecutor", java.util.concurrent.Executor.class),
        start =               Class.forName("com.sun.net.httpserver.HttpServer").  getMethod("start");
        Object server = create.invoke(null, new java.net.InetSocketAddress((int)args[0]), 0);
        createContext.invoke(server, "/", java.lang.reflect.Proxy.newProxyInstance(
            HttpHandler.getClassLoader(), 
            new Class[] { HttpHandler }, 
            new java.lang.reflect.InvocationHandler() {
                private java.nio.charset.Charset UTF8 = java.nio.charset.Charset.forName("UTF-8");
                private byte data[] = new byte[200000];
                private java.util.function.Function&lt;Object,String&gt; stringify = (oj) -&gt; {
                    return "\""+(""+oj).replace("\\", "\\\\").replace("\n", "\\n").replace("\b", "\\b").
                                        replace("\t", "\\t").replace("\r", "\\r").replace("\f", "\\f").
                                        replace("\"", "\\\"") +"\"";
                };
                
                private void send(Object httpExchange,byte array[],int max, String contentType) throws Exception {
                    set.invoke(getResponseHeaders.invoke(httpExchange), "Content-Type",contentType);
                    sendResponseHeaders.invoke(httpExchange, 200, max);
                    java.io.OutputStream os = (java.io.OutputStream) getResponseBody.invoke(httpExchange); 
                    os.write(array,0, max);
                    os.close();
                }
                
                public synchronized Object invoke(Object pxy, java.lang.reflect.Method mthd, Object[] args) throws Throwable {
                    Object httpExchange = args[0]; 
                    String uri = getRequestURI.invoke(httpExchange).toString();
                    if (uri.startsWith("/js")) {
                        String query = (String) getQuery.invoke(getRequestURI.invoke(httpExchange));
                        String id = '"'+query.substring(0, 10)+'"'; 
                        String code = query.substring(11);
                        Object result = null;
                        try {
                            result = engine.eval(code);
                        } catch (Exception e) {
                            final java.io.ByteArrayOutputStream baos = new java.io.ByteArrayOutputStream();
                            e.printStackTrace(new java.io.PrintStream(baos));
                            byte array[] = ("n4j.on("+id+","+stringify.apply(baos)+",null)").getBytes(UTF8);
                            send(httpExchange,array,array.length,"application/javascript");
                            return null; 
                        }
                        byte[] array = ("n4j.on("+id+",null,"+stringify.apply(result)+")").getBytes(UTF8);
                        send(httpExchange,array,array.length,"application/javascript");
                        return null; 
                    }
                    String url = "https://lorenzoongithub.github.io/nudge4j/proxy"+uri;
                    java.net.HttpURLConnection con = (java.net.HttpURLConnection) new java.net.URL(url).openConnection();
                    con.setRequestMethod("GET");
                    int responseCode = con.getResponseCode();
                    if (responseCode != 200) {
                        sendResponseHeaders.invoke(httpExchange,responseCode,-1);
                        return null; 
                    }
                    java.io.InputStream is = con.getInputStream();
                    int count = 0; 
                    while (true) {
                        int b = is.read();
                        if (b == -1) break; 
                        data[count++] = (byte) b;
                    }
                    is.close();
                    send(httpExchange,data, count,  (
                         (uri.endsWith(".ico")) ? "image/x-icon" :
                         (uri.endsWith(".css")) ? "text/css" :
                         (uri.endsWith(".png")) ? "image/png" :  
                         (uri.endsWith(".js"))  ? "application/javascript" : 
                                                  "text/html"));
                    return null; 
                }
            }
        ));
        setExecutor.invoke(server, new Object[] { null });
        start.invoke(server);
        System.out.println("nudge4j serving on port:"+args[0]);
    } catch (Exception e) {
        throw new InternalError(e);
    }
}}).accept( new Object[] { 5050  }); 
}}}</textarea>
</div>

<h2>The way it works</h2>
<ul>
<li>The snippet of java code starts a web-server in your JVM allowing for javascript serverside executions</li>
<li>You can expose any java object as arguments, though the first argument must be the server's port</li>
<li>The web-server serves html and other static resources from <a href='https://lorenzoongithub.github.io/nudge4j/proxy/'>https://lorenzoongithub.github.io/nudge4j/proxy/</a></li>
<li>We use ajax <a href='https://github.com/lorenzoongithub/nudge4j/blob/master/docs/proxy/nudge4j.js'>(nudge4j.js)</a> to post code to execute against the JVM</li>
</ul>


<!-- 
<h2>Credits</h2>
Nudge4j was written by me, Lorenzo Puccetti. 
I like javascript and I like seeing javascript running inside JVM.
It's incredibly powerful. So much so that many times I had integrated it I had to worry more about how to constrain it than anything else.
Nudge4j is an attempt to polish my past works so to create a REPL environment by combining javascript and a web server. 
 -->

</div>


<!--  footer -->
<div style='margin:400px 0 10px 0;text-align:center;font-size:11px;'>
Nudge4J<br>Copyright Â© 2017 - <a href='https://github.com/lorenzoongithub/'>Lorenzo Puccetti</a>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-87683649-1', 'auto');
  ga('send', 'pageview');
 
</script>
<a href="https://github.com/lorenzoongithub/nudge4j"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/a6677b08c955af8400f44c6298f40e7d19cc5b2d/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677261795f3664366436642e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"></a>
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.5.13/clipboard.min.js"></script>
<script>
var clipboard = new Clipboard('.xbtn');
</script>
</body>
</html>